<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DXF Generator Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg relative">
      <h1 class="text-2xl font-bold mb-4 text-center">DXF Generator Test</h1>

      <!-- Shape selection -->
      <label for="shape" class="block mb-2 font-semibold">Select Shape:</label>
      <select id="shape" class="w-full border rounded p-2 mb-4">
        <option value="">-- Choose a shape --</option>
        <option value="cone">Cone</option>
        <option value="frustum_cone">Frustum Cone</option>
        <option value="frustum_cone_triangulation">Frustum Cone (Triangulation)</option>
        <option value="pyramid">Pyramid</option>
        <option value="rectangle_to_rectangle">Rectangle to Rectangle</option>
        <option value="flange">Flange</option>
        <option value="truncated_cylinder">Truncated Cylinder</option>
        <option value="bend">Simple Bend</option>
        <option value="elbow">Pipe Elbow (Flat Pattern)</option>
      </select>

      <!-- Dynamic input fields -->
      <div id="fields"></div>

      <!-- Submit button -->
      <button id="generateBtn" onclick="generateDXF()" 
        class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
        Generate DXF
      </button>

      <!-- Results -->
      <div id="results" class="mt-6 hidden border-t pt-4 text-gray-700">
        <h2 class="font-semibold text-lg mb-2">ðŸ“Š Calculated Values</h2>
        <ul id="calcList" class="list-disc ml-6 space-y-1"></ul>
        <button id="downloadBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
          Download DXF
        </button>
      </div>

      <!-- Loading overlay -->
      <div id="loading" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center rounded-xl">
        <div class="flex flex-col items-center">
          <svg class="animate-spin h-8 w-8 text-blue-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l3 3-3 3v-4a8 8 0 01-8-8z"></path>
          </svg>
          <p class="text-blue-700 font-semibold">Generating DXF...</p>
        </div>
      </div>
    </div>

    <script>
      const fieldsDiv = document.getElementById("fields");
      const shapeSelect = document.getElementById("shape");
      const loadingOverlay = document.getElementById("loading");
      const resultsDiv = document.getElementById("results");
      const calcList = document.getElementById("calcList");
      const downloadBtn = document.getElementById("downloadBtn");
      let lastDXFBase64 = null;

      const defaultValues = {
        diameter: 200,
        height: 100,
        angle: 20,
        n: 4,
        diameter1: 300,
        diameter2: 150,
        beta: 120,
        AA: 200,
        AB: 150,
        H: 300,
        ab: 200,
        bc: 150,
        AB: 400,
        BC: 300,
        D1: 50,
        D2: 80,
        D3: 120,
        D4: 150,
        N1: 6,
        d1: 8,
        N2: 4,
        d2: 12
      };

      const shapeFields = {
        cone: ["diameter", "height"],
        pyramid: ["AA", "AB", "H"],
        rectangle_to_rectangle: ["ab", "bc", "H", "AB", "BC"],
        flange: ["D1", "D2", "D3", "D4", "N1", "d1", "N2", "d2"],
        // âœ… updated for new parameters
        truncated_cylinder: ["diameter", "height", "angle", "n"],
        bend: ["diameter", "bend_angle", "radius", "divisions"],
        elbow: ["R", "alpha", "D", "N", "n"]
      };

      shapeSelect.addEventListener("change", () => {
        const shape = shapeSelect.value;
        fieldsDiv.innerHTML = "";
        resultsDiv.classList.add("hidden");

        if (shape && shapeFields[shape]) {
          shapeFields[shape].forEach(f => {
            const label = document.createElement("label");
            label.className = "block mt-2 font-medium";
            label.textContent = `${f} ${f === "angle" ? "(Â°)" : "(mm)"}`;

            const input = document.createElement("input");
            input.type = "number";
            input.id = f;
            input.className = "w-full border rounded p-2 mt-1";
            input.step = "any";
            if (defaultValues[f] !== undefined) input.value = defaultValues[f];
            fieldsDiv.appendChild(label);
            fieldsDiv.appendChild(input);
          });
        }
      });

      async function generateDXF() {
        const shape = shapeSelect.value;
        if (!shape) {
          alert("Please select a shape!");
          return;
        }

        const params = {};
        if (shapeFields[shape]) {
          shapeFields[shape].forEach(f => {
            const val = parseFloat(document.getElementById(f).value);
            if (!isNaN(val)) params[f] = val;
          });
        }

        const payload = { shape, params };
        console.log("ðŸŸ¦ Payload sent:", payload);

        loadingOverlay.classList.remove("hidden");
        resultsDiv.classList.add("hidden");

        try {
          const res = await fetch("https://flat-pattern-production.up.railway.app/generate_dxf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!res.ok) throw new Error("Error generating DXF");
          const json = await res.json();
          console.log("âœ… Response:", json);

          calcList.innerHTML = "";
          if (json.data) {
            for (const [k, v] of Object.entries(json.data)) {
              const li = document.createElement("li");
              // handle array output (like h_values)
              if (Array.isArray(v)) {
                li.textContent = `${k} = [${v.join(", ")}]`;
              } else {
                li.textContent = `${k} = ${v}`;
              }
              calcList.appendChild(li);
            }
          }

          resultsDiv.classList.remove("hidden");
          lastDXFBase64 = json.dxf_base64;
        } catch (err) {
          alert(err.message);
          console.error(err);
        } finally {
          loadingOverlay.classList.add("hidden");
        }
      }

      downloadBtn.addEventListener("click", () => {
        if (!lastDXFBase64) return alert("No DXF available yet!");
        const byteChars = atob(lastDXFBase64);
        const byteNumbers = new Array(byteChars.length);
        for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: "application/dxf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${shapeSelect.value}.dxf`;
        a.click();
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>

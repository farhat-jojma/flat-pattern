<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DXF Generator Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg relative">
      <h1 class="text-2xl font-bold mb-4 text-center">DXF Generator Test</h1>

      <!-- Shape selection -->
      <label for="shape" class="block mb-2 font-semibold">Select Shape:</label>
      <select id="shape" class="w-full border rounded p-2 mb-4">
        <option value="">-- Choose a shape --</option>
        <option value="cone">Cone</option>
        <option value="frustum_cone">Frustum Cone</option>
        <option value="frustum_cone_triangulation">Frustum Cone (Triangulation)</option>
        <option value="pyramid">Pyramid</option>
        <option value="rectangle_to_rectangle">Rectangle to Rectangle</option>
        <option value="flange">Flange</option>
        <option value="truncated_cylinder">Truncated Cylinder</option>
        <option value="bend">Pipe bend</option>
        <option value="circle_to_rectangle">Circle to Rectangle</option>
        <option value="rectangle_to_circle">Rectangle to Circle</option>
        <option value="rectangle_to_circle_ecc">Rectangle to Circle Eccentric</option>
        <option value="frustum_ecc_angle">Frustum Eccentric (Angle)</option>
        <option value="frustum_ecc_paral">Frustum Eccentric (Parallel)</option>
        <option value="offset_cone">Offset Cone</option>
        <option value="sphere">Sphere</option>
        <option value="auger">Auger (Spiral Segment)</option>
        <option value="breeches_full">Breeches (2-Branch)</option>
        <option value="offset_tee">Offset Tee</option>
        <option value="tee_oblique">Tee Oblique (Y-Tee)</option>
        <option value="tee_eccentric">Tee Eccentric</option>
        <option value="tee_on_bend">Tee on Bend</option>
        <option value="tee_on_cone">Tee on Cone</option>
        <option value="pants">Pants</option>
        <option value="pants2">Pants 2 (3-Branch)</option>
        <option value="pants_ecc">Pants Ecc (Y-piece avec excentration)</option>
      </select>

      <!-- Dynamic input fields -->
      <div id="fields"></div>

      <!-- Submit button -->
      <button
        id="generateBtn"
        onclick="generateDXF()"
        class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition"
      >
        Generate DXF
      </button>

      <!-- Results -->
      <div id="results" class="mt-6 hidden border-t pt-4 text-gray-700">
        <h2 class="font-semibold text-lg mb-2">üìä Calculated Values</h2>
        <ul id="calcList" class="list-disc ml-6 space-y-1"></ul>
        <button
          id="downloadBtn"
          class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
        >
          Download DXF
        </button>
      </div>

      <!-- Loading overlay -->
      <div
        id="loading"
        class="hidden absolute inset-0 bg-white/80 flex items-center justify-center rounded-xl"
      >
        <div class="flex flex-col items-center">
          <svg
            class="animate-spin h-8 w-8 text-blue-600 mb-2"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l3 3-3 3v-4a8 8 0 01-8-8z"
            ></path>
          </svg>
          <p class="text-blue-700 font-semibold">Generating DXF...</p>
        </div>
      </div>
    </div>

    <script>
      const fieldsDiv = document.getElementById("fields");
      const shapeSelect = document.getElementById("shape");
      const loadingOverlay = document.getElementById("loading");
      const resultsDiv = document.getElementById("results");
      const calcList = document.getElementById("calcList");
      const downloadBtn = document.getElementById("downloadBtn");
      let lastDXFBase64 = null;

      // Default values
      const defaultValues = {
        diameter: 200,
        height: 150,

        d: 100,
        d1: 20,
        d2: 10,
        D: 200,
        D1: 200,
        D2: 100,
        D3: 250,
        D4: 150,

        L: 300,
        L1: 150,
        L2: 100,

        H: 150,

        R: 300,

        S: 400,

        X: 50,
        Y: 30,

        beta: 120,
        angle: 30,
        alpha: 90,

        n: 12,
        N: 12,
        N1: 8,
        N2: 6,

        a: 45,
        ab: 200,
        bc: 150,
        A: 200,
        B: 150,
        AA: 200,
        AB: 150,
        BC: 100,
      };

      // Shape fields
      const shapeFields = {
        cone: ["diameter", "height"],
        frustum_cone: ["D1", "D2"],
        frustum_cone_triangulation: ["D1", "D2", "H", "n"],
        pyramid: ["AA", "AB", "H"],
        rectangle_to_rectangle: ["ab", "bc", "H", "AB", "BC"],
        flange: ["D1", "D2", "D3", "D4", "N1", "d1", "N2", "d2"],
        truncated_cylinder: ["diameter", "height", "angle", "n"],
        bend: ["R", "alpha", "D", "N", "n"],
        circle_to_rectangle: ["D", "H", "A", "B", "n"],
        rectangle_to_circle: ["A", "B", "D", "H", "n"],
        rectangle_to_circle_ecc: ["A", "B", "D", "H", "X", "Y", "n"],
        frustum_ecc_angle: ["D1", "D2", "H", "X", "alpha", "n"],
        frustum_ecc_paral: ["D1", "D2", "H", "X", "n"],
        offset_cone: ["D", "H", "X", "n"],
        sphere: ["D", "N", "n"],
        auger: ["D", "d", "S"],
        breeches_full: ["D", "L1", "L2", "n", "a"],
        offset_tee: ["D", "d", "L", "X", "n", "a"],
        tee_oblique: ["D", "d", "L1", "a", "n"],
        tee_eccentric: ["D", "d", "H", "X", "n"],
        tee_on_bend: ["D", "d", "R", "H", "n"],
        tee_on_cone: ["D1", "D2", "L", "A", "d", "H", "X", "n"],
        pants: ["D1", "D2", "H", "X", "n"],
        pants2: ["D1", "D2", "H", "X", "a", "n"],
        pants_ecc: ["D1", "D2", "H", "X", "Y", "n"],
      };

      // Labels
      const labelMap = {};

      // Generate fields
      shapeSelect.addEventListener("change", () => {
        const shape = shapeSelect.value;
        fieldsDiv.innerHTML = "";
        resultsDiv.classList.add("hidden");

        if (shape && shapeFields[shape]) {
          // --- 1Ô∏è‚É£ Generate basic inputs ---
          shapeFields[shape].forEach((f) => {
            const label = document.createElement("label");
            label.className = "block mt-2 font-medium";
            label.textContent = labelMap[f] || f;

            const input = document.createElement("input");
            input.type = "number";
            input.id = f;
            input.className = "w-full border rounded p-2 mt-1";
            input.step = "any";
            if (defaultValues[f] !== undefined) input.value = defaultValues[f];

            fieldsDiv.appendChild(label);
            fieldsDiv.appendChild(input);
          });

          // --- 2Ô∏è‚É£ If frustum_cone ‚Üí add mode selector ---
          if (shape === "frustum_cone") {
            const modeDiv = document.createElement("div");
            modeDiv.className = "mt-4";

            modeDiv.innerHTML = `
              <p class="font-semibold mb-1">Mode de calcul :</p>
              <label class="mr-4">
                <input type="radio" name="mode" value="H" checked> Avec hauteur (H)
              </label>
              <label>
                <input type="radio" name="mode" value="B"> Avec angle Œ≤
              </label>

              <div id="extraField" class="mt-3"></div>
            `;

            fieldsDiv.appendChild(modeDiv);

            const extraFieldDiv = modeDiv.querySelector("#extraField");

            function updateExtraField() {
              const mode = document.querySelector('input[name="mode"]:checked').value;
              extraFieldDiv.innerHTML = "";

              const label = document.createElement("label");
              label.className = "block mt-2 font-medium";
              label.textContent = mode === "H" ? labelMap["H"] : labelMap["beta"];

              const input = document.createElement("input");
              input.type = "number";
              input.id = mode === "H" ? "H" : "beta";
              input.className = "w-full border rounded p-2 mt-1";
              input.step = "any";
              input.value = defaultValues[mode === "H" ? "H" : "beta"];

              extraFieldDiv.appendChild(label);
              extraFieldDiv.appendChild(input);
            }

            // Initialize and handle changes
            updateExtraField();
            modeDiv.querySelectorAll('input[name="mode"]').forEach((r) => {
              r.addEventListener("change", updateExtraField);
            });
          }
        }
      });

      // Generate DXF
      async function generateDXF() {
        const shape = shapeSelect.value;
        if (!shape) return alert("Please select a shape!");

        const params = {};
        if (shapeFields[shape]) {
          shapeFields[shape].forEach((f) => {
            const val = parseFloat(document.getElementById(f)?.value);
            if (!isNaN(val)) params[f] = val;
          });
        }

        // For frustum cone: handle the mode
        if (shape === "frustum_cone") {
          const mode = document.querySelector('input[name="mode"]:checked').value;
          params.mode = mode;
          if (mode === "H") params.H = parseFloat(document.getElementById("H").value);
          else params.beta = parseFloat(document.getElementById("beta").value);
        }

        console.log("üü¶ Payload:", { shape, params });

        loadingOverlay.classList.remove("hidden");
        resultsDiv.classList.add("hidden");

        try {
          const res = await fetch("http://127.0.0.1:5000/generate_dxf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ shape, params }),
          });
          if (!res.ok) throw new Error("Error generating DXF");
          const json = await res.json();

          calcList.innerHTML = "";
          const data = json.data || json;
          for (const [k, v] of Object.entries(data)) {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${k}</strong>: ${v}`;
            calcList.appendChild(li);
          }

          resultsDiv.classList.remove("hidden");
          lastDXFBase64 = json.dxf_base64;
        } catch (err) {
          alert(err.message);
          console.error(err);
        } finally {
          loadingOverlay.classList.add("hidden");
        }
      }
      downloadBtn.addEventListener("click", () => {
        if (!lastDXFBase64) return alert("No DXF available yet!");
        const byteChars = atob(lastDXFBase64);
        const byteNumbers = new Array(byteChars.length);
        for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: "application/dxf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${shapeSelect.value}.dxf`;
        a.click();
        URL.revokeObjectURL(url);
      });
    </script>

  </body>
</html>
